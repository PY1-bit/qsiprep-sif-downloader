name: 构建 QSIPrep 镜像

on:
  workflow_dispatch: # 仅手动触发

jobs:
  build-qsiprep:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 Apptainer (快速可靠版)
        run: |
          sudo apt-get update
          # 1. 安装 Apptainer 的运行依赖和构建工具
          sudo apt-get install -y \
            wget \
            uidmap \
            fuse-overlayfs \
            squashfs-tools \
            cryptsetup
          # 2. 下载并安装官方预编译包（最快最稳）
          wget https://github.com/apptainer/apptainer/releases/download/v1.3.4/apptainer_1.3.4_amd64.deb
          sudo dpkg -i apptainer_1.3.4_amd64.deb || sudo apt-get install -f -y
          # 3. 验证安装
          apptainer --version

      - name: 配置构建环境与镜像加速
        run: |
          # 核心修改：在工作区创建临时目录，而非 RUNNER_TEMP
          WORKSPACE_TMP_DIR="$GITHUB_WORKSPACE/apptainer_build"
          mkdir -p "$WORKSPACE_TMP_DIR"
          
          # 将路径设置为环境变量
          echo "APPTAINER_TMPDIR=$WORKSPACE_TMP_DIR/tmp" >> $GITHUB_ENV
          echo "APPTAINER_CACHEDIR=$WORKSPACE_TMP_DIR/cache" >> $GITHUB_ENV
          echo "APPTAINER_DOCKER_HUB_MIRROR=https://mirror.ccs.tencentyun.com" >> $GITHUB_ENV
          
          # 创建子目录
          mkdir -p "$WORKSPACE_TMP_DIR"/{tmp,cache}
          
          # 验证：显示工作区和临时目录的可用空间
          echo "工作区目录: $GITHUB_WORKSPACE"
          df -h "$GITHUB_WORKSPACE"
          echo "临时目录已设置为: $WORKSPACE_TMP_DIR"

      - name: 拉取并构建 QSIPrep 镜像 (.sif)
        run: |
          # 显示环境变量以确认配置生效
          echo "临时目录: $APPTAINER_TMPDIR"
          echo "镜像加速: $APPTAINER_DOCKER_HUB_MIRROR"
          
          # **核心修正3 & 4：拉取一个确定的、存在的版本（例如0.19.1），并设置长超时**
          # 根据你之前提供的截图，pennbbl/qsiprep:0.19.1 是确定存在的。
          timeout 2400 apptainer pull qsiprep-0.19.1.sif docker://pennbbl/qsiprep:0.19.1
          
          # 验证文件
          ls -lh qsiprep-*.sif
          echo "✅ SIF 镜像构建成功！"
          echo "⚠️  请注意：由于文件巨大，GitHub Actions 无法将其作为 Artifact 上传。"
          echo "📥 你需要通过其他方式（如SCP、网盘或直接从Runner下载）获取此文件。"

      # **核心修正3：已移除 `upload-artifact` 步骤，因为必然失败**
