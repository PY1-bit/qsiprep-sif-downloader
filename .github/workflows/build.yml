name: 构建 QSIPrep 镜像

on:
  workflow_dispatch: # 仅手动触发

jobs:
  build-qsiprep:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 Apptainer (快速可靠版)
        run: |
          sudo apt-get update
          # 1. 安装 Apptainer 的运行依赖和构建工具
          sudo apt-get install -y \
            wget \
            uidmap \
            fuse-overlayfs \
            squashfs-tools \
            cryptsetup
          # 2. 下载并安装官方预编译包（最快最稳）
          wget https://github.com/apptainer/apptainer/releases/download/v1.3.4/apptainer_1.3.4_amd64.deb
          sudo dpkg -i apptainer_1.3.4_amd64.deb || sudo apt-get install -f -y
          # 3. 验证安装
          apptainer --version

      - name: 配置构建环境与镜像加速
        run: |
          # **核心修正1：将变量存入GITHUB_ENV，使其跨步骤生效**
          echo "APPTAINER_TMPDIR=$RUNNER_TEMP/apptainer_tmp" >> $GITHUB_ENV
          echo "APPTAINER_CACHEDIR=$RUNNER_TEMP/apptainer_cache" >> $GITHUB_ENV
          # **核心修正2：设置镜像加速器，而不是替换整个仓库地址**
          echo "APPTAINER_DOCKER_HUB_MIRROR=https://mirror.ccs.tencentyun.com" >> $GITHUB_ENV
          # 创建目录
          mkdir -p $RUNNER_TEMP/apptainer_{tmp,cache}

      - name: 拉取并构建 QSIPrep 镜像 (.sif)
        run: |
          # 显示环境变量以确认配置生效
          echo "临时目录: $APPTAINER_TMPDIR"
          echo "镜像加速: $APPTAINER_DOCKER_HUB_MIRROR"
          
          # **核心修正3 & 4：拉取一个确定的、存在的版本（例如0.19.1），并设置长超时**
          # 根据你之前提供的截图，pennbbl/qsiprep:0.19.1 是确定存在的。
          timeout 2400 apptainer pull qsiprep-0.19.1.sif docker://pennbbl/qsiprep:0.19.1
          
          # 验证文件
          ls -lh qsiprep-*.sif
          echo "✅ SIF 镜像构建成功！"
          echo "⚠️  请注意：由于文件巨大，GitHub Actions 无法将其作为 Artifact 上传。"
          echo "📥 你需要通过其他方式（如SCP、网盘或直接从Runner下载）获取此文件。"

      # **核心修正3：已移除 `upload-artifact` 步骤，因为必然失败**
