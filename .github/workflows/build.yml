name: Build QSIPrep SIF

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'QSIPrep 版本号（如 1.0.2）'
        required: true
        default: '1.0.2'

jobs:
  build:
    runs-on: ubuntu-latest-4-cores   # ✅ 150 GB 磁盘
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Apptainer
        run: |
          sudo apt-get update
          sudo apt-get install -y wget uidmap fuse-overlayfs squashfs-tools
          wget https://github.com/apptainer/apptainer/releases/download/v1.3.4/apptainer_1.3.4_amd64.deb
          sudo dpkg -i apptainer_1.3.4_amd64.deb || sudo apt-get -f install -y
          apptainer --version

      - name: Build SIF
        run: |
          export APPTAINER_TMPDIR=${{ runner.temp }}/apptainer_tmp
          export APPTAINER_CACHEDIR=${{ runner.temp }}/apptainer_cache
          mkdir -p "$APPTAINER_TMPDIR" "$APPTAINER_CACHEDIR"

          timeout 3600 apptainer pull \
            qsiprep-${{ github.event.inputs.version }}.sif \
            docker://pennlinc/qsiprep:${{ github.event.inputs.version }}

          ls -lh qsiprep-${{ github.event.inputs.version }}.sif

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: qsiprep-${{ github.event.inputs.version }}-sif
          name: QSIPrep ${{ github.event.inputs.version }} SIF
          files: qsiprep-${{ github.event.inputs.version }}.sif
          token: ${{ secrets.GITHUB_TOKEN }}
