name: Build QSIPrep SIF

on:
  workflow_dispatch:
    # å¯é€‰ï¼šæ·»åŠ æ‰‹åŠ¨è§¦å‘æ—¶çš„ç‰ˆæœ¬å‚æ•°ï¼ˆçµæ´»åˆ‡æ¢ç‰ˆæœ¬ï¼‰
    inputs:
      qsiprep_version:
        description: 'QSIPrepç‰ˆæœ¬ï¼ˆé»˜è®¤0.24.0ï¼‰'
        required: true
        default: '0.24.0'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬ï¼Œæ— åˆ™ç”¨é»˜è®¤
      QSIPREP_VERSION: ${{ github.event.inputs.qsiprep_version || '0.24.0' }}
      APPTAINER_TMPDIR: ${{ runner.temp }}/apptainer_tmp
      APPTAINER_CACHEDIR: ${{ runner.temp }}/apptainer_cache
      # åŒé•œåƒæºå…œåº•ï¼ˆè…¾è®¯äº‘å¤±è´¥è‡ªåŠ¨åˆ‡åä¸ºäº‘ï¼‰
      DOCKER_MIRROR_1: https://mirror.ccs.tencentyun.com
      DOCKER_MIRROR_2: https://swr.cn-north-4.myhuaweicloud.com
      QSIPREP_IMAGE_URL: "docker://pennlinc/qsiprep:${{ env.QSIPREP_VERSION }}"

    steps:
      - name: ğŸ” é¢„æ£€æŸ¥ï¼šéªŒè¯å·¥ä½œæµè§¦å‘æ­£å¸¸
        run: |
          echo "âœ… å·¥ä½œæµè§¦å‘æˆåŠŸï¼å½“å‰ç‰ˆæœ¬ï¼š${QSIPREP_VERSION}"
          echo "âœ… Runnerä¸´æ—¶ç›®å½•ï¼š${RUNNER_TEMP}"
          echo "âœ… ç³»ç»Ÿä¿¡æ¯ï¼š$(uname -a)"
          df -h / /mnt  # æå‰æ‰“å°ç£ç›˜çŠ¶æ€

      - name: Checkout code
        uses: actions/checkout@v4

      # ç¬¬ä¸€æ­¥å…ˆæ¸…ç†ç£ç›˜ï¼ˆå…³é”®ï¼å®‰è£…ä¾èµ–å‰é‡Šæ”¾æœ€å¤§ç©ºé—´ï¼‰
      - name: ğŸ§¹ æ·±åº¦æ¸…ç†ç£ç›˜ç©ºé—´ï¼ˆé‡Šæ”¾â‰¥25GBï¼‰
        run: |
          # å¸è½½è¶…å¤§æ— ç”¨åŒ…ï¼ˆGitHub Runneré»˜è®¤å¸¦çš„snap/dockerå 10+GBï¼‰
          sudo apt-get autoremove -y --purge linux-headers-* linux-image-* snapd docker* containerd*
          # æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /usr/share/doc /usr/share/man /tmp/* /var/tmp/*
          # æ‰©å®¹ä¸´æ—¶åˆ†åŒºï¼šæŒ‚è½½20GBï¼ˆæ¯”15GBæ›´ç¨³å¦¥ï¼‰
          sudo fallocate -l 20G /mnt/apptainer_tmp_disk || sudo truncate -s 20G /mnt/apptainer_tmp_disk
          sudo mkfs.ext4 -F /mnt/apptainer_tmp_disk
          sudo mkdir -p $APPTAINER_TMPDIR
          sudo mount /mnt/apptainer_tmp_disk $APPTAINER_TMPDIR
          sudo chmod 777 $APPTAINER_TMPDIR
          # æ‰“å°è¯¦ç»†ç£ç›˜ä¿¡æ¯ï¼ˆå…³é”®è°ƒè¯•ï¼‰
          echo "===== ç£ç›˜ä½¿ç”¨æƒ…å†µ ====="
          df -h
          echo "===== ä¸´æ—¶ç›®å½•æƒé™ ====="
          ls -ld $APPTAINER_TMPDIR
          echo "===== å†…å­˜çŠ¶æ€ ====="
          free -h

      # å®‰è£…é¢„ç¼–è¯‘Apptainerï¼ˆå¢åŠ é‡è¯•+ç‰ˆæœ¬æ ¡éªŒï¼‰
      - name: ğŸ“¦ å®‰è£…Apptainerï¼ˆé¢„ç¼–è¯‘åŒ…+é‡è¯•æœºåˆ¶ï¼‰
        run: |
          # é‡è¯•3æ¬¡é¿å…ç½‘ç»œé—®é¢˜
          for i in {1..3}; do
            sudo apt-get update && sudo apt-get install -y wget uidmap fuse-overlayfs && break
            echo "âš ï¸ APTæ›´æ–°å¤±è´¥ï¼Œç¬¬$iæ¬¡é‡è¯•..."
            sleep 5
          done
          # ä¸‹è½½é¢„ç¼–è¯‘åŒ…ï¼ˆåŠ æ ¡éªŒå’Œï¼‰
          wget -q --show-progress https://github.com/apptainer/apptainer/releases/download/v1.3.4/apptainer_1.3.4_amd64.deb \
            -O apptainer_1.3.4_amd64.deb
          # æ ¡éªŒåŒ…å®Œæ•´æ€§ï¼ˆé¿å…ä¸‹è½½æŸåï¼‰
          echo "b9c05960d6a94d58b8417486117549d4  apptainer_1.3.4_amd64.deb" | md5sum -c - || exit 1
          # å®‰è£…ï¼ˆè‡ªåŠ¨è¡¥ä¾èµ–ï¼‰
          sudo dpkg -i apptainer_1.3.4_amd64.deb || sudo apt-get -f install -y
          # éªŒè¯å®‰è£…+é…ç½®FUSEé©±åŠ¨
          apptainer --version || { echo "âŒ Apptainerå®‰è£…å¤±è´¥"; exit 1; }
          sudo mkdir -p /usr/local/etc/apptainer
          echo "user overlay enable = yes" | sudo tee -a /usr/local/etc/apptainer/apptainer.conf
          echo "mount program = /usr/bin/fuse-overlayfs" | sudo tee -a /usr/local/etc/apptainer/apptainer.conf
          # å¯ç”¨fakerootï¼ˆé¿å…æƒé™é—®é¢˜ï¼‰
          sudo apptainer config fakeroot --enable

      # é…ç½®ç¯å¢ƒå˜é‡+åŒé•œåƒæºå…œåº•
      - name: âš™ï¸ é…ç½®æ„å»ºç¯å¢ƒï¼ˆåŒé•œåƒæºå…œåº•ï¼‰
        run: |
          mkdir -p $APPTAINER_TMPDIR $APPTAINER_CACHEDIR
          # æµ‹è¯•é•œåƒæºè¿é€šæ€§ï¼Œé€‰å¯ç”¨çš„
          if curl -s --connect-timeout 5 $DOCKER_MIRROR_1 > /dev/null; then
            export APPTAINER_DOCKER_HUB_MIRROR=$DOCKER_MIRROR_1
            echo "âœ… ä½¿ç”¨é•œåƒæºï¼š$DOCKER_MIRROR_1"
          else
            export APPTAINER_DOCKER_HUB_MIRROR=$DOCKER_MIRROR_2
            echo "âœ… åˆ‡æ¢é•œåƒæºï¼š$DOCKER_MIRROR_2"
          fi
          # å†™å…¥ç¯å¢ƒå˜é‡ï¼ˆå…¨å±€ç”Ÿæ•ˆï¼‰
          echo "APPTAINER_DOCKER_HUB_MIRROR=$APPTAINER_DOCKER_HUB_MIRROR" >> $GITHUB_ENV
          # éªŒè¯å˜é‡
          echo "APPTAINER_TMPDIR: $APPTAINER_TMPDIR"
          echo "APPTAINER_CACHEDIR: $APPTAINER_CACHEDIR"
          echo "APPTAINER_DOCKER_HUB_MIRROR: $APPTAINER_DOCKER_HUB_MIRROR"

      # æ‹‰å–é•œåƒï¼ˆå¢åŠ é‡è¯•+è¶…æ—¶å…œåº•ï¼‰
      - name: ğŸš€ æ‹‰å–QSIPrepé•œåƒï¼ˆé‡è¯•+è¶…æ—¶å…œåº•ï¼‰
        run: |
          # æ˜¾å¼å¯¼å‡ºæ‰€æœ‰å˜é‡
          export APPTAINER_TMPDIR=$APPTAINER_TMPDIR
          export APPTAINER_CACHEDIR=$APPTAINER_CACHEDIR
          export APPTAINER_DOCKER_HUB_MIRROR=$APPTAINER_DOCKER_HUB_MIRROR
          # é‡è¯•2æ¬¡ï¼ˆç½‘ç»œæ³¢åŠ¨å…œåº•ï¼‰
          for i in {1..2}; do
            echo "ğŸ”„ ç¬¬$iæ¬¡æ‹‰å–é•œåƒï¼š$QSIPREP_IMAGE_URL"
            timeout 2400 apptainer pull --disable-cache qsiprep-${QSIPREP_VERSION}.sif $QSIPREP_IMAGE_URL && break
            echo "âš ï¸ ç¬¬$iæ¬¡æ‹‰å–å¤±è´¥ï¼Œæ¸…ç†ä¸´æ—¶æ–‡ä»¶åé‡è¯•..."
            rm -rf $APPTAINER_TMPDIR/*
            sleep 10
          done
          # ä¸¥æ ¼æ ¡éªŒ
          if [ ! -f "qsiprep-${QSIPREP_VERSION}.sif" ]; then
            echo "âŒ é•œåƒæ‹‰å–å¤±è´¥ï¼"
            exit 1
          fi
          # æ‰“å°é•œåƒè¯¦ç»†ä¿¡æ¯
          echo "===== é•œåƒä¿¡æ¯ ====="
          ls -lh qsiprep-${QSIPREP_VERSION}.sif
          apptainer inspect qsiprep-${QSIPREP_VERSION}.sif | grep -E "Version|Name"
          md5sum qsiprep-${QSIPREP_VERSION}.sif > qsiprep-${QSIPREP_VERSION}.md5  # ç”Ÿæˆæ ¡éªŒæ–‡ä»¶

      # ä¸Šä¼ äº§ç‰©ï¼ˆåŠ æ ¡éªŒæ–‡ä»¶ï¼‰
      - name: ğŸ“¤ ä¸Šä¼ Artifactï¼ˆå«æ ¡éªŒæ–‡ä»¶ï¼‰
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: qsiprep-${{ env.QSIPREP_VERSION }}-sif
          path: |
            qsiprep-${{ env.QSIPREP_VERSION }}.sif
            qsiprep-${{ env.QSIPREP_VERSION }}.md5
          retention-days: 7
          if-no-files-found: error

      # å¯é€‰ï¼šä¸Šä¼ åˆ°Releaseï¼ˆæ”¯æŒå¤§æ–‡ä»¶ï¼Œæ— éœ€åˆ†å·ï¼‰
      - name: ğŸ¯ ä¸Šä¼ åˆ°GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: qsiprep-${{ env.QSIPREP_VERSION }}
          name: QSIPrep ${{ env.QSIPREP_VERSION }} SIF
          files: |
            qsiprep-${{ env.QSIPREP_VERSION }}.sif
            qsiprep-${{ env.QSIPREP_VERSION }}.md5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš¨ å¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: failure()
        run: |
          echo "âŒ å·¥ä½œæµå¤±è´¥ï¼å…³é”®ä¿¡æ¯ï¼š"
          echo "ç‰ˆæœ¬ï¼š${QSIPREP_VERSION}"
          echo "ä¸´æ—¶ç›®å½•ï¼š${APPTAINER_TMPDIR}"
          echo "ç£ç›˜å‰©ä½™ï¼š$(df -h / | awk 'NR==2{print $4}')"
          # å¯é€‰ï¼šæ·»åŠ é’‰é’‰/ä¼ä¸šå¾®ä¿¡é€šçŸ¥
          # curl -X POST https://oapi.dingtalk.com/robot/send -d '{"msgtype":"text","text":{"content":"QSIPrepæ„å»ºå¤±è´¥ï¼"}}'
