name: Build QSIPrep SIF

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      QSIPREP_VERSION: "0.24.0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo apt-get autoremove -y --purge snapd
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /usr/share/doc /usr/share/man /tmp/*
          df -h

      - name: Install Apptainer
        run: |
          sudo apt-get update
          sudo apt-get install -y wget uidmap fuse-overlayfs
          wget https://github.com/apptainer/apptainer/releases/download/v1.3.4/apptainer_1.3.4_amd64.deb
          sudo dpkg -i apptainer_1.3.4_amd64.deb || sudo apt-get -f install -y
          apptainer --version

      - name: Pull QSIPrep image
        run: |
          export APPTAINER_TMPDIR=${{ runner.temp }}/apptainer_tmp
          export APPTAINER_CACHEDIR=${{ runner.temp }}/apptainer_cache
          export APPTAINER_DOCKER_HUB_MIRROR=https://mirror.ccs.tencentyun.com
          mkdir -p "$APPTAINER_TMPDIR" "$APPTAINER_CACHEDIR"

          timeout 2400 apptainer pull \
            qsiprep-${{ env.QSIPREP_VERSION }}.sif \
            docker://swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/pennlinc/qsiprep:${{ env.QSIPREP_VERSION }}

          ls -lh qsiprep-${{ env.QSIPREP_VERSION }}.sif

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: qsiprep-${{ env.QSIPREP_VERSION }}-sif
          name: QSIPrep ${{ env.QSIPREP_VERSION }} SIF
          files: qsiprep-${{ env.QSIPREP_VERSION }}.sif
          token: ${{ secrets.GITHUB_TOKEN }}
